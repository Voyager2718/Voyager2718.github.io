_.Module.define({path:"common/widget/Icons/IconsBookMessagebox",requires:["IconCard"],sub:{_icon_book_message_box:null,_icon_data:null,_is_show:false,_option:{width:290},is_leave_close:false,setLeaveClose:function(a){this.is_leave_close=a},initial:function(){},showBox:function(b,c){var a=this;a._showBox(c);a.generatorBuySlot(b);a._bindEvents()},hideBox:function(){var a=this;if(!a._is_show){if(a._icon_book_message_box){a._icon_book_message_box.closeCard();a._icon_book_message_box=null}}},_bindEvents:function(){var a=this;var b=$(".icon_card_wrap");b.bind("mouseenter",function(){if(a.is_leave_close){a._is_show=true}});b.bind("mouseleave",function(){if(a.is_leave_close){a._is_show=false;a.hideBox()}})},generatorBuySlot:function(c){var a=this;var b=a._getBuySlotTpl(c);$(".icon_book_msgbox_body").html(b);$(".icon_book_msgbox .ui_btn").click(function(){a.buySlot(c)})},showReplaceFirstSlotBox:function(c,d,f,b){var a=this;setTimeout(function(){b.closeTip()},0);a._showBox(d);var e=a._getReplaceFirstSlotTipTpl(c);$(".icon_book_msgbox_body").html(e);$(".icon_book_msgbox .ui_btn").click(function(){f.call(b,c)})},showBuyIconBox:function(b,d,f,c){var a=this;setTimeout(function(){c.closeTip()},0);a._showBox(d);var e=a._getBuyIconTpl(b);$(".icon_book_msgbox_body").html(e);$(".icon_book_msgbox .ui_btn").click(function(){var i=0,h=PageData.user.Parr_scores;if(h){i=h.scores_other+h.scores_money}if(i-b.icon_info.price<0){var g=a._hasNotEnoughTdou();$(".icon_book_msgbox_body").html(g);$(".j_tdou_not_enough").on("click",function(){_.Module.use("common/widget/TchargeDialog")});return}else{f.call(c,b.icon_info,function(){var j=a._buyIconSuccess();$(".icon_book_msgbox_body").html(j)})}})},buySlot:function(e){var b=this;var g=0,c=PageData.user.Parr_scores;if(c){g=c.scores_other+c.scores_money+c.scores_fetch}var d=-1;if(!e.price){d=e.icon_info.price}else{d=e.price}if(d>0&&g-d<0){var a=b._hasNotEnoughTdou();$(".icon_book_msgbox_body").html(a);$(".j_tdou_not_enough").on("click",function(){_.Module.use("common/widget/TchargeDialog")});return}var f={ie:"utf-8"};f.tbs=PageData.tbs;b._ajax&&b._ajax.abort();b._ajax=$.ajax({type:"post",url:"/icon/addslot",data:f,dataType:"json"}).success(function(k){if(k&&k.no===0){var m=k.data;var i=b._addSuccess();$(".icon_book_msgbox_body").html(i);b._refreshSlotList();var h=m.scores_other||0;var l=m.scores_money||0;b._updateTdouAccount(m.scores_other,m.scores_money,m.scores_fetch)}else{if(k&&k.no===2270028){b.hasNotEnoughTdou()}else{var j='<div class="icon_book_error">\u672a\u77e5\u9519\u8bef<a href="javascript:void(0)" id="icon_book_reload" class="icon_book_reload">\u5237\u65b0</a></div>';$(".icon_book_msgbox_body").html(j);$("#icon_book_reload").on("click",function(){$.tb.location.reload();return false})}}})},_updateTdouAccount:function(d,b,a){var e=0,c=PageData.user.Parr_scores;if(c){c.scores_other=d;c.scores_money=b;c.scores_fetch=a;$(".j_userinfo_scores_num").html(d+b)}},_showBox:function(d){var a=this;a.hideBox();var c=a._getTpl();var b={content:c,card_css:{width:a._option.width,zIndex:$.getcurzIndex()},auto_positon:true,event_target:d,attr:"id='icon_book_message_box'",wrap:$("body")};a._icon_book_message_box=a.use("common/widget/Icons/IconCard",b);a._icon_book_message_box.showCard({type:"delayShow",time:200});a._bindCloseEvent()},_bindCloseEvent:function(){var a=this;$(".icon_book_msgbox .icon_book_msgbox_close").click(function(){if(a._icon_book_message_box){a._icon_book_message_box.closeCard();a._icon_book_message_box=null}else{if($("#icon_book_message_box").length>0){$("#icon_book_message_box").remove()}}$(".icon_wrap .j_icon_slot_refresh").removeClass("icon_slot_refresh")});$(".icon_book_msgbox .icon_book_msgbox_close").hover(function(){$(this).addClass("icon_book_msgbox_close_hover")},function(){$(this).removeClass("icon_book_msgbox_close_hover")})},_getTpl:function(){var a=['<div class="icon_book_msgbox">','<div class="icon_book_msgbox_wrap">','<div class="icon_book_msgbox_body">',"</div>",'<div class="icon_book_msgbox_close"></div>',"</div>",'<div class="icon_book_down_arrow"></div>',"</div>"].join("");return a},_refreshSlotList:function(){var a=$(".j_icon_slot").length;var c=a*28;var b='<a href="javascript:void(0)" data-slot="'+(a+1)+'" data-name="" title="\u70b9\u51fb\u6dfb\u52a0\u5370\u8bb0" class="j_slot_null_icon j_icon_slot icon_slot_null_icon" style="top:0px;left:'+c+'px"><div class=" j_icon_slot_refresh"></div></a>';$(".icon_slot_wrap .icon_add_solt").css({left:(a+1)*28});$(".icon_slot_wrap .icon_add_solt").before(b);if($(".j_icon_slot").length==8){$(".icon_add_solt").remove()}},_addSuccess:function(){var a=['<div class="icon_msgbox_title"></div>','<div class="icon_msgbox_detail">\u606d\u559c\u60a8\u83b7\u5f97\u4e86\u4e00\u679a\u5370\u8bb0\u63d2\u69fd</div>'].join("");return a},_buyIconSuccess:function(){var a=['<div class="icon_msgbox_title">\u606d\u559c\u60a8\u83b7\u5f97\u4e86\u4e00\u679a\u65b0\u5370\u8bb0</div>','<div class="icon_msgbox_detail"></div>','<div class="icon_msgbox_action">','<a href="javascript:void(0)" class="ui_btn ui_btn_m j_tdou_not_enough" style="height: 27px; border-radius: 3px;"><span><em>\u5feb\u53bb\u56fe\u9274\u770b\u770b\u5427</em></span></a>',"</div>"].join("");return a},_replaceIconSuccess:function(){var a=['<div class="icon_msgbox_title">\u5370\u8bb0\u66ff\u6362\u6210\u529f</div>','<div class="icon_msgbox_detail"></div>','<div class="icon_msgbox_action">','<a  href="javascript:void(0)" class="ui_btn ui_btn_m j_replace_ok" style="height: 27px; border-radius: 3px;"><span><em>\u786e\u5b9a</em></span></a>',"</div>"].join("");return a},_hasNotEnoughTdou:function(){var a=['<div class="icon_msgbox_title">T\u8c46\u4e0d\u8db3</div>','<div class="icon_msgbox_detail"></div>','<div class="icon_msgbox_action">','<a href="javascript:void(0)" class="ui_btn ui_btn_m j_tdou_not_enough" style="height: 27px; border-radius: 3px;"><span><em>\u7acb\u5373\u5145\u503c</em></span></a>',"</div>"].join("");return a},_getBuySlotTpl:function(c){var b={price:c.price};var a=['<div class="icon_msgbox_title">\u9700\u8981\u6d88\u8017#{price}T\u8c46\u5f00\u542f\u5370\u8bb0\u63d2\u69fd</div>','<div class="icon_msgbox_detail" style="font-size: 12px; font-style: italic;padding-top: 5px;">\u53ef\u7528\u8c46\u7968\u652f\u4ed8\uff0c\u6700\u9ad8\u6d88\u80178000\u8c46\u7968</div>','<div class="icon_msgbox_detail" style="padding-top:15px;">(\u5f00\u542f\u540e\u514d\u8d39\u66f4\u6362\u5370\u8bb0)</div>','<div class="icon_msgbox_action" style="padding-top: 25px;">','<a href="javascript:void(0)" class="ui_btn ui_btn_m" style="height: 27px; border-radius: 3px;"><span><em>\u5f00\u542f</em></span></a>',"</div>"].join("");return $.tb.format(a,b)},_getReplaceFirstSlotTipTpl:function(g){var b=this;var a=g.old_icon_info;var e=g.icon_info;var h=b._getIconBackground(a);var f=b._getIconBackground(e);var d={old_background:h,background:f};var c=['<div class="icon_msgbox_title">\u70b9\u51fb\u66ff\u6362\u5f53\u524d\u5370\u8bb0</div>','<div class="icon_msgbox_icon_replace_detail">','<div class="msg_icon_replace_current" style="#{old_background}"></div>','<div class="msg_icon_replace_arrow"></div>','<div class="msg_icon_replace_new" style="#{background}"></div>',"</div>",'<div class="icon_msgbox_action">','<a href="javascript:void(0)" class="ui_btn ui_btn_m" style="height: 27px; border-radius: 3px"><span><em>\u66ff\u6362</em></span></a>',"</div>"].join("");return $.tb.format(c,d)},_getIconBackground:function(h){var f=0;var c=0;var g="http://tb1.bdstatic.com/tb/cms/com/icon/icon_sprite.png";if(h){var i=h.sprite[h.value].split(",");var e=50;var a=i[0];var d=i[1];f=(3-1)*e;c=d*e;var b="background: url("+g+"?stamp="+a+") no-repeat -"+c+"px -"+f+"px;";return b}},_getBuyIconTpl:function(e){var a=this;var d=a._getIconBackground(e.icon_info);var c={price:e.icon_info.price,background:d};var b=['<div class="icon_msgbox_title">\u9700\u8981\u6d88\u801710000T\u8c46\u8d2d\u4e70\u8be5\u5370\u8bb0</div>','<div class="icon_msgbox_icon_buy">','<div class="msg_icon_buy_icon" style="#{background}}"></div>',"</div>",'<div class="icon_msgbox_action">','<a href="javascript:void(0)" class="ui_btn ui_btn_m">',"<span><em>\u8d2d\u4e70</em></span>","</a>","</div>",].join("");return $.tb.format(b,c)},hasNotEnoughTdou:function(c){var b=this;if(!c){c=$(".icon_wrap .j_icon_slot_refresh")}b._showBox(c);var a=b._hasNotEnoughTdou();$(".icon_book_msgbox_body").html(a);$(".j_tdou_not_enough").on("click",function(){_.Module.use("common/widget/TchargeDialog")})},replaceIconSuccess:function(c){var b=this;var d=$(".icon_wrap .icon_slot_refresh");if(d){d=d.parent()}b._showBox(d);var a=b._replaceIconSuccess();$(".icon_book_msgbox_body").html(a);$(".icon_book_msgbox_body .j_replace_ok").on("click",function(){$.tb.location.reload()});$(".icon_book_msgbox .icon_book_msgbox_close").click(function(){$.tb.location.reload()});if(c){var e=c.getControl();e&&e.closeIconBook()}}}});