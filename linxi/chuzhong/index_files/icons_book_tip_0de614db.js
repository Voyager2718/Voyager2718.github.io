_.Module.define({path:"common/widget/Icons/IconsBookTip",requires:["IconCard","IconsBookMessagebox"],sub:{_icon_book_tip:null,_icon_data:null,_ajax:null,_control:null,_msgbox:null,_option:{width:"535px"},_is_show:false,initial:function(b){var a=this;a._control=b[0]},getControl:function(){return this._control},showTip:function(e,m){if(!e){return}var l=this;var j=$("#icon_book_tip");if(j.length==0){$(".icon_card_wrap").append(this._getWrapTpl())}j=$("#icon_book_tip");l._setContent(e);var i=$(".j_icon_book_tip .j_tip_up_arrow");var d=m.position();var g=d.top;var b=d.left-5;var h=m.parents(".icon_view");var k=h.position();var c=parseInt(k.left)+15;var a=g+106;if(m.parents(".collect_wrap").length>0){a+=146}j.css({display:"block",visibility:"visible",top:a+"px",left:c+"px","z-index":20000});var f=parseInt(b)+25;i.css({left:f+"px"});l._bindEvents();$(".icon_book_tip .j_tip_icon_price").html("\u6d88\u8017"+e.icon_info.price+"T\u8c46");l._icon_data=e;$("#j_icon_book_action_btn").bind("click",function(){var n=true;var r=0,o=PageData.user.Parr_scores;if(o){r=o.scores_other+o.scores_money}var q=-1;if(l._icon_data.price){q=l._icon_data.price}else{q=l._icon_data.icon_info.price}if(q>0&&r-q<0){n=false;$(".icon_book_tip .icon_action_wrap").html(l._getNoRemainTip());$("#j_icon_book_recharge_btn").click(function(){_.Module.use("common/widget/TchargeDialog")})}if(e.in_use){if(parseInt(e.slot_no)==1){l._replaceIcon4FirstSlot(e)}else{l._replaceIcon4OtherSlot(e)}}else{if(n){var p=$("#j_icon_book_action_btn em");if(p.length>0){p.html("\u8d2d\u4e70\u4e2d")}l._buyIconRequest(e)}}})},hideTip:function(){var a=this;if(!a._is_show){a.closeTip()}},closeTip:function(){tip=$("#icon_book_tip");if(!tip&&tip.length==0){return}tip.remove()},_bindEvents:function(){var b=$("#icon_book_tip");var a=this;b.bind("mouseenter",function(){a._is_show=true});b.bind("mouseleave",function(){a._is_show=false;a.hideTip()})},_replaceIcon4FirstSlot:function(c){var b=this;b._control.closeIconBook();if(!b._msgbox){b._msgbox=b.use("common/widget/Icons/IconsBookMessagebox")}var a=$(".icon_wrap .icon_slot_refresh");b._msgbox.showReplaceFirstSlotBox(c,a,b._replaceIcon4OtherSlot,b)},_replaceIcon4OtherSlot:function(b){var a=this;var c={ie:"utf-8"};c.tbs=PageData.tbs;c.icon_name=b.icon_id;c.slot_no=b.slot_no;a._ajax&&a._ajax.abort();a._ajax=$.ajax({type:"post",url:"/icon/seticon",data:c,dataType:"json"}).success(function(e){if(e&&e.no===0){var f=e.data;a._refreshAfterReplace(f.icon_info)}else{if(e&&e.no===2270028){if(!a._msgbox){a._msgbox=a.use("common/widget/Icons/IconsBookMessagebox")}a._msgbox.hasNotEnoughTdou()}else{var d='<div class="icon_book_error">\u672a\u77e5\u9519\u8bef<a href="javascript:void(0)" id="icon_book_reload" class="icon_book_reload">\u5237\u65b0</a></div>'}}})},_refreshAfterReplace:function(b){var a=this;setTimeout(function(){a.closeTip()},0);if(!a._msgbox){a._msgbox=a.use("common/widget/Icons/IconsBookMessagebox")}a._msgbox.replaceIconSuccess(a);return},_setSoltIconBg:function(g,i){var j=g.sprite[g.value].split(",");var e=50;var a=j[0];var b=j[1];var c=(2-1)*e;var d=b*e;var h="http://tb1.bdstatic.com/tb/cms/com/icon/icon_sprite.png";var f=" url("+h+"?stamp="+a+") no-repeat -"+d+"px -"+c+"px;";if(i&&i.children("span").length>0){i.children("span").css({background:f})}else{i.css({background:f});i.removeClass("j_slot_null_icon");i.removeClass("icon_slot_null_icon");i.tbattr("title","")}},_buyIcon:function(c){var b=this;b._control.closeIconBook();if(!b._msgbox){b._msgbox=b.use("common/widget/Icons/IconsBookMessagebox")}var a=$(".icon_wrap .icon_slot_refresh");b._msgbox.showBuyIconBox(c,a,b._buyIconRequest,b)},_buyIconRequest:function(b){var a=this;var c={ie:"utf-8"};c.tbs=PageData.tbs;c.icon_name=b.icon_id;c.level=b.value;a._ajax&&a._ajax.abort();a._ajax=$.ajax({type:"post",url:"/icon/buyIcon",data:c,dataType:"json"}).success(function(g){if(g&&g.no===0){var j=g.data;parr=PageData.user.Parr_scores;parr.scores_fetch=j.scores_fetch||0;parr.scores_money=j.scores_money||0;parr.scores_other=j.scores_other||0;parr.scores_total=j.scores_total;$(".j_userinfo_scores_num").html(parr.scores_money+parr.scores_other);var f=$(".tab_body_item_active .icon_view .icon_box_place");for(var e=0;e<f.length;e++){var h=$(f[e]);if(h.tbattr("data-id")==j.icon_name){h.removeClass("icon_not_use");a.closeTip();break}}}else{if(g&&g.no===2270028){if(!a._msgbox){a._msgbox=a.use("common/widget/Icons/IconsBookMessagebox")}a._msgbox.hasNotEnoughTdou()}else{var d='<div class="icon_book_error">\u672a\u77e5\u9519\u8bef<a href="javascript:void(0)" id="icon_book_reload" class="icon_book_reload">\u5237\u65b0</a></div>'}}})},_refreshAfterBuy:function(a){this._refreshAfterReplace(a)},_setContent:function(b){var a=this._getTpl(b);$("#icon_book_tip").html(a)},_getWrapTpl:function(){var a=['<div id="icon_book_tip" class="icon_tip_card_wrap">',"</div>"].join("");return a},_getNoRemainTip:function(){var a=['<div class="icon_action" style="padding-top: 10px">','<div class="j_tip_icon_price tip_icon_price" style="height: 12px; margin-bottom:5px;display: block">T\u8c46\u4e0d\u8db3</div>','<a href="javascript:void(0)" id="j_icon_book_recharge_btn" class="ui_btn ui_btn_m" style="height: 27px; border-radius: 3px;"><span><em>\u5145\u503c</em></span></a>',"</div>"].join("");return a},_getTpl:function(j){var o=this;var c=PageUnit.load("icons_new_cfg")||{};var l=j.icon_info;var n=l.sprite[l.value].split(",");var h=50;var b=n[0];var e=n[1];var f=(3-1)*h;var g=e*h;var m="http://tb1.bdstatic.com/tb/cms/com/icon/icon_sprite.png";var i=" background:url("+m+"?stamp="+b+") no-repeat -"+g+"px -"+f+"px;";var d=l.name+"_"+j.value;var a={background_img:i,desc_title:c[d][0]||"\u5370\u8bb0",desc_detail:c[d][2]||"",desc_link:c[d][3]||"http://tieba.baidu.com/",btn_value:j.in_use?"\u66ff\u6362":"\u8d2d\u4e70",price_info_display:j.in_use==1?"none":"block",padding_top:j.in_use?"20":"10",in_use_display:"none",in_use_text:"",button_display:(j.in_use==0&&l.price==0)?"none":"block"};if(o._judgeCommIconInSlot(j.icon_id)){a.button_display="none"}if(a.button_display=="none"){a.in_use_display="display";a.in_use_text="\u4f7f\u7528\u4e2d";a.price_info_display="none"}if(j.in_use==0&&l.price==0){a.in_use_text="\u6d3b\u52a8\u83b7\u53d6"}var k=['<div class="icon_book_tip j_icon_book_tip">','<div class="tip_up_arrow j_tip_up_arrow"></div>','<div class="tip_body">','<div class="tip_icon">','<div class="tip_icon_img" style="#{background_img}}"></div>',"</div>",'<div class="icon_desc">','<div class="icon_desc_title"><span>#{desc_title}</span></div>','<div class="icon_desc_detail"><span>#{desc_detail}</span><a href="#{desc_link}"  target="_blank"><span style="padding-left:5px;">\u8be6\u60c5 >></span></a></div>',"</div>",'<div class="icon_action_wrap">','<div class="icon_action" style="padding-top:#{padding_top}px">','<div class="j_tip_icon_price tip_icon_price" style="height: 12px; margin-bottom:5px;display: #{price_info_display}"></div>','<div class="j_tip_icon_use tip_icon_use" style=" margin-bottom:5px;display: #{in_use_display}">#{in_use_text}</div>','<a href="javascript:void(0)" id="j_icon_book_action_btn" class="ui_btn ui_btn_m icon_book_action_btn" style="height: 27px; border-radius: 3px;display: #{button_display}"><span><em>#{btn_value}</em></span></a>',"</div>","</div>","</div>","</div>"].join("");return $.tb.format(k,a)},_judgeCommIconInSlot:function(c){var a=PageData.new_iconInfo||{};for(var b in a){if(a[b].name==c){return true}}return false}}});