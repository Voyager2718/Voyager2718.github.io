var initItiebaMessage;new (function(){TbICom.call(this);var a="";var P=[];var f;var g;var T;var ag;var w;var M;var aj=0;var e=[];var n={atme:0,light:0,reply:0,favts:0,recycle:0};var d={prop:0,score:0};var G="default";var X=false;var N={all_msg:{id:0,display:true,aside_tip_id:"",url:""},fans:{id:1,url:"#itb_home#&type=fans",aside_tip_id:"",display:true},____prop_out_of_date:{id:2,url:"/tbmall/message",aside_tip_id:"tbmall_num_tip",display:true},scores:{id:3,url:"/tbmall/getTdou",aside_tip_id:"tbmall_num_tip",display:true},reply:{id:4,url:"#itb_home#&type=replyme",aside_tip_id:"new_reply_num_tip",display:true},feature:{id:5,url:"#itb_home#&type=feature",aside_tip_id:"new_feature_num_tip",display:true},guess:{id:6,url:"#itb_home#&type=main",aside_tip_id:"new_guess_num_tip",display:true},postPasser:{id:8,display:false},atme:{id:9,url:"#itb_home#&type=atme",aside_tip_id:"new_atme_num_tip",display:true},recycle:{id:10,url:"/pmc/recycle",aside_tip_id:"new_recycle_num_tip",display:true},invite:{id:11,url:"#itb_home#",aside_tip_id:"new_invite_num_tip",display:true},prop_out_of_date:{id:12,url:"/tbmall/message",aside_tip_id:"tbmall_num_tip",display:true},paperprops:{id:16,url:"http://tieba.baidu.com/tb/zt/tietiao/index.html",aside_tip_id:"new_paperprops_num_tip",display:true},gameOpen:{id:17,url:"/game/index",aside_tip_id:"new_gameOpen_num_tip",display:true},lotteryDraw:{id:18,url:"/f?kw=%B2%CA%C6%B1&tab=lc_mylottery#/user/order",aside_tip_id:"new_lotteryDraw_num_tip",display:true},lotteryAward:{id:19,url:"/f?kw=%B2%CA%C6%B1&tab=lc_mylottery#/user/account",aside_tip_id:"new_lotteryAward_num_tip",display:true},favts:{id:20,url:"#itb_home#&type=storethread",aside_tip_id:"new_storethread_num_tip",display:true},meizhiLevelUp:{id:15,url:"#other_url#?type=meizhiLevelUp",aside_tip_id:"new_meizhiLevelUp_tip",display:true}};var C={itb_home:""};var ab=function(an,al){g=an;T=al||$("body");var am=TbCom.process("MsgSystem","getIsReady");if(am){l()}else{TbCom.addEvent("MsgSystem","ready",function(){l()})}};var l=function(){if(X){return}if(g!="itieba"){a="_blank"}var al=TbCom.process("User","getUserInfo");if(!al||!al.is_login||!al.portrait){TbCom.process("User","getUserInfoByRequest",Y)}else{Y(al)}X=true};var Y=function(al){f=al.portrait;C.itb_home="/i/sys/jump?u="+f;for(var am in N){P[N[am]["id"]]=am}for(var an in N){var ao=N[an];if(typeof ao.url!="undefined"){switch(an){case"guess":N[an]["url"]=ao.url.replace(/#itb_home#/g,"/i/app/"+an+"?uc="+f);break;case"invite":N[an]["url"]=ao.url.replace(/#itb_home#/g,"/f/i/invite");break;case"meizhiLevelUp":N[an]["url"]=ao.url.replace(/#other_url#/g,"/encourage/get/meizhi/jump");break;default:N[an]["url"]=ao.url.replace(/#itb_home#/g,"/i/sys/jump?u="+f)}}}j();y();TbCom.addEvent("MsgSystem","sys_message",Z);TbCom.addEvent("MsgSystem","listenComplete",c);S()};var j=function(){var ar=P;var al=[];al.push('<div class="allMsg" style="clear:both;"><ul>');for(var ao=0,am=ar.length;ao<am;ao++){al.push('<li id="message_'+ar[ao]+'" style="display:none;"></li>')}al.push("</ul>");al.push('<div class="tb_msg_tip_rightpanel">');al.push('<a href="'+C.itb_home+'&type=profile#notify" style="height:100%;" target="_self" class="setting">设置</a>');al.push('<a title="关闭" href="#" onclick="return false;" class="close_msg_tip"></a>');al.push('<b style="clear:both; text-align:left;"></b>');al.push("</div></div>");var aq=$("#com_userbar").find(".u_setting>div"),av=aq.offset().left,at=av?av:0,an=$("body").width();_right=an-at-100,_right=_right>350?180:_right;var ap={content:al.join(""),arrow_dir:"up",bubble_css:{right:_right,width:170,top:25},arrow_pos:{left:30},level:2,attr:" id='com_userbar_message' ",wrap:T};var au=new UiBubbleTipBase(ap);au.setFixedForMessage();ag=au.j_bubble;w=au;$("#mobile_promote_download").bind("click",function(){_.Module.use("common/component/diversionDialog",[],function(aw){aw.showDiversionDialog("webtbnews")})})};var y=function(){$("body").on("click",".close_msg_tip",function(){TbCom.process("UserMessage","clearAllData");$(this).closest(".allMsg").find(".j_clear_notify").each(function(){var al=$(this).getData().type;$.tb.Storage.remove(al)});return false});$(window).on("beforeunload",function(){var am=0,al=e.length;aj=1;for(;am<al;am++){if(window.Notification){e[am].close()}else{if(window.webkitNotifications){e[am].cancel()}}}})};var z=function(al){TbCom.process("MsgSystem","doSomethingAfterReady",function(){al()})};var S=function(){var am="http://message.tieba.baidu.com/i/msg/get_data";var al=am+"?user="+f;$.JsLoadManager.use(al)};var s=function(al){z(function(){switch(al){case"favts":r();break;default:ak(al);h(al)}})};var ak=function(ao){var an=new Date().getTime();var ap=N[ao]["id"];if(ap!==20){var am="http://message.tieba.baidu.com/i/msg/clear_data?type="+ap+"&user="+f+"&stamp="+an;var al=new Image();window["itieba_msg_clearer_"+an]=al;al.src=am}};var I=function(){z(function(){for(var al in N){if(al!="all_msg"){ak(al)}}q()})};var ah=function(){var am=new Date().getTime();var al="/tsmg?query=get_data&uid="+f+"&stamp="+am;$.get(al,function(an){if(an&&an.no==0){k(an.data.ret);V()}},"json")};var r=function(){var am=new Date().getTime();var al="/tsmg?query=clear_data&uid="+f+"&stamp="+am;$.get(al,function(an){if(an&&an.no==0){k(0);V()}},"json")};var ac=function(al){if(al&&al.length>19){al=al.splice(0,19)}var am=al.join(",");ah();O(am);TbCom.process("MsgSystem","sendMsg","other","sys","all_msg",am,"default",null,false)};initItiebaMessage=ac;var h=function(al){z(function(){if(!al||al==""){return}TbCom.process("MsgSystem","sendMsg","all","sys",al,"0","default",null,false)})};var q=function(){TbCom.process("MsgSystem","sendMsg","all","sys","clear_msg","all","default",null,false);TbCom.process("MsgSystem","removeMsgByMod","sys","command_listen");r()};var E=function(){var al="/f?ct=486539264&cm=59202&tn=jsonUserInfo&t="+Math.random();$.get(al,{},function(am){var an=$.json.decode(am);if(an.beans_num){TbCom.process("MsgSystem","sendMsg","all","sys","wealth",an.beans_num,"default",null,false);setTimeout(function(){ak("wealth");TbCom.process("MsgSystem","removeMsg","sys","wealth")},100)}})};var c=function(ap,ao){var an=ao.mod;var al=P[ao.msg.type];var am=ao.msg.cnt;if(an=="sys"&&al=="wealth"){E();return}TbCom.process("MsgSystem","sendMsg","all",an,al,am,"default",null,false)};var Z=function(ao,an){if(!an){$.console.debug("@UserMessage _renderMsg : 不需要处理！")}else{var am=an.type,al=an.content;if(am&&typeof al!="undefined"){x(am,al)}else{$.console.debug("@UserMessage _renderMsg : 返回的数据中没有type和content")}}};var x=function(al,am){switch(al){case"all_msg":O(am);break;case"fans":D(am);break;case"scores":W(am);break;case"reply":p(am);V();break;case"feature":af(am);break;case"guess":aa(am);break;case"atme":Q(am);V();break;case"prop_out_of_date":i(am);break;case"invite":U(am);break;case"paperprops":b(am);case"favts":k(am);break;case"recycle":K(am);V();break;case"clear_msg":ad(am);break;case"gameOpen":v(am);break;case"meizhiLevelUp":A(am);break;case"lotteryDraw":J(am);break;case"lotteryAward":ai(am);default:$.console.debug("@UserMessage _renderMsgHandler; LCF返回的消息没有处理函数");break}};var D=function(am){var al=parseInt(am);if(al>0){R("fans",al,"新粉丝");F("fans",al,"新粉丝")}else{L("fans")}};var i=function(am){var al=parseInt(am);if(al>0){R("prop_out_of_date",al,"T豆商城信息");F("prop_out_of_date",al,"T豆商城信息")}else{L("prop_out_of_date")}};var W=function(am){var al=parseInt(am);if(al>0){R("scores",al,"赠送10T豆信息");F("scores",al,"赠送10T豆信息")}else{L("scores")}};var af=function(ao){var an=parseInt(ao);var al=$("#new_feature_num_tip");var am="";if(an>0){R("feature",an,"新精品");F("feature",an,"新精品");am="("+ao+"新)"}else{L("feature")}if(al){al.html(am)}};var p=function(am){var al=parseInt(am);n.reply=al;if(al>0){R("reply",al,"新回复");F("reply",al,"新回复")}else{L("reply")}};var V=function(){var an=n.reply+n.atme+n.light+n.recycle;if(an>0){var al=$("#new_reply_num_tip");var am="";am="("+an+"新)";if(al){al.html(am)}}else{var al=$("#new_reply_num_tip").html("")}};var k=function(ao){var an=parseInt(ao);n.favts=an;if(an>0){var al=$("#new_storethread_num_tip");var am="";am="("+an+"贴有更新)";if(al){al.html(am)}R("favts",an,"收藏贴有更新");F("favts",an,"收藏贴有更新");$.stats.sendRequest("fr=tb0_forum&st_mod=msgsys&st_type=favtshow")}else{L("favts")}};var K=function(am){var al=parseInt(am);n.recycle=al;if(al>0){R("recycle",al,"回收站提醒");F("recycle",al,"回收站提醒")}else{L("recycle")}};var aa=function(am){var al=parseInt(am);if(al>0){R("guess",al,"竞猜结果");F("guess",al,"竞猜结果")}else{L("guess")}};var U=function(am){var al=parseInt(am);n.invite=al;if(al>0){R("invite",al,"粉丝福利卡");F("invite",al,"粉丝福利卡")}else{L("invite")}};var b=function(am){var al=parseInt(am);n.paperprops=al;if(al>0){R("paperprops",al,"贴条道具信息");F("paperprops",al,"贴条道具信息")}else{L("paperprops")}};var B=function(am){var al=parseInt(am);n.invite=al;if(al>0){R("newask",al,"名片新请求")}else{L("newask")}};var u=function(am){var al=parseInt(am);n.invite=al;if(al>0){R("newcard",al,"新名片")}else{L("newcard")}};var v=function(am){var al=parseInt(am);if(al>0){R("gameOpen",al,"游戏开服通知");F("gameOpen",al,"游戏开服通知")}else{L("gameOpen")}};var A=function(am){var al=parseInt(am);if(al>0){R("meizhiLevelUp",null,"妹纸，Mvp升级了！");F("meizhiLevelUp",null,"妹纸，Mvp升级了！")}else{L("meizhiVote")}};var J=function(am){var al=parseInt(am);if(al>0){R("lotteryDraw",al,"彩票开奖提醒");F("lotteryDraw",al,"彩票开奖提醒")}else{L("lotteryDraw")}};var ai=function(am){var al=parseInt(am);if(al>0){R("lotteryAward",al,"彩票中奖提醒");F("lotteryAward",al,"彩票中奖提醒")}else{L("lotteryAward")}};var Q=function(am){var al=parseInt(am);n.atme=al;if(al>0){R("atme",al,"@提到我");F("atme",al,"@提到我")}else{L("atme")}};var ae=function(am){var al=parseInt(am);n.light=al;if(al>0){R("light",al,"点亮我")}else{L("light")}};var ad=function(at){var ar=ag;var aq=ar.find("li");for(var ap=0,am=aq.length;ap<am;ap++){$(aq[ap]).css("display","none")}ar.css("display","none");var al=null;var ao="";for(var an in N){ao=N[an]["aside_tip_id"];if(typeof ao=="string"&&ao!=""){al=$("#"+ao);if(al){al.html("");al.css("display","none")}}}};var O=function(ar){var aq=ar.split(",");var ao=P;var ap=ao.length-1;var am;for(var an=0,al=aq.length;an<al;an++){num=aq[an];if(an<ap){am=ao[an+1];x(am,num)}}};var o=function(at){var ar=ag;var aq=ag.find("li");for(var ap=0,am=aq.length;ap<am;ap++){$(aq[ap]).css("display","none")}if(w){w.hideBubble()}var al=null;var ao="";for(var an in N){ao=N[an]["aside_tip_id"];if(typeof ao=="string"&&ao!=""){al=$("#"+ao);if(al){al.html("");al.css("display","none")}}}};var t=function(al){G=al};var m=function(){return(window.Notification&&window.Notification.permission=="granted")||(window.webkitNotifications&&window.webkitNotifications.checkPermission()==0)};var F=function(am,al,ao){var an=function(aq,ap,ar){if(!m()){return}this.notify=null;this.init(aq,ap,ar)};an.conf={title:"贴吧消息通知",icon:{}};an.prototype={constructor:an,init:function(ar,aq,aw){var av=an.conf.title,au="/tb/static-common/img/notify/"+ar+".png",at="您有"+aq+"个"+aw,ap=N[ar]["url"];if($.tb.Storage.get(ar)!=aq){this.createNotify(av,au,at,ar);this.setEvent(ar,aq,ap);e.push(this.notify);$.tb.Storage.set(ar,aq)}},createNotify:function(au,ar,aq,ap){var at=null;if(at=window.Notification){this.notify=new Notification(au,{icon:ar,body:aq,tag:ap})}else{if(at=window.webkitNotifications){this.notify=at.createNotification(ar,au,aq);this.notify.replaceId=ap;this.notify.show()}}},closeNotify:function(ap){if(window.Notification){if(ap.currentTarget){ap.currentTarget.close()}}else{if(window.webkitNotifications){ap.currentTarget.cancel()}}},setEvent:function(au,at,ar){var aq=this,av=aq.notify,ap=0;av.ondisplay=function(ax){var aw=setTimeout(function(){ap=1;aq.closeNotify(ax);clearTimeout(aw)},20*1000)};av.onshow=function(ay){var aw=20;if($.browser.mozilla){aw=3}var ax=setTimeout(function(){ap=1;aq.closeNotify(ay);clearTimeout(ax)},aw*1000)};av.onclick=function(aw){aq.closeNotify(aw);window.open(ar)};av.onclose=function(){if(ap!=1&&aj!=1){s(au);$.tb.Storage.remove(au)}};av.onerror=function(){}}};return new an(am,al,ao)};var R=function(aq,an,at){var av=$("#message_"+aq)||null;var ao=N[aq];if(ao.display==false||!av){return}var ar=ao.id;var al=ao.url;var au="st_mod="+aq+"_tip&fr=tb0_"+g;var ap=$("<span>"+an+"个</span>");var am=$('<a class="j_clear_notify">'+at+"</a>").bindData({type:aq});am.tbattr({href:al,target:a});am.bind("click",function(){s(aq);$.tb.Storage.remove(aq);$.stats.track((aq||"")+"_click","user_message")});av.html("");an!==null&&av.append(ap);av.append(am);av.css("display","block");if(w){w.showBubble()}$("#u_xiangce").find(".j_wrap").hide()};var L=function(ao){var am=$("#message_"+ao);var aq=ag;var ap=aq.find("li");am.css("display","none");var ar=true;for(var an=0,al=ap.length;an<al;an++){if($(ap[an]).css("display")!="none"){ar=false;break}}aq.css("display",ar?"none":"block")};var H=function(am,al){if(!am||!(am in N)){return}N[am]["display"]=!!(al)};this.initSys("UserMessage",["User","MsgSystem","WealthSystem"],{init:ab,clearSysMsg:h,clearData:s,clearAllData:I,setWealthActionType:t,setMsgDisplay:H})})();