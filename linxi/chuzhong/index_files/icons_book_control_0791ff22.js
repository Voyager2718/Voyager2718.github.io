_.Module.define({path:"common/widget/Icons/IconsBookControl",requires:["IconsBookView","IconsBookTip","IconCard","IconsBookMessagebox","IconsBookGetIcon"],sub:{_icon_book:null,_icon_book_ajax:null,_icon_user_action:"",_icon_tab_loaded:{},_tip:null,_messagebox:null,tabLen:0,_slot_no:0,_icon_info:{},_current_tab_index:0,_selected_icon_name:"",_target_ele:null,_option:{width:655},_slot_buy_price:[0,0,100,10000,30000,50000,10000,20000,100000],initial:function(b){var a=this;a._wrap=$("body");a._view=a.use("common/widget/Icons/IconsBookView");a._target_ele=null;var c=PageUnit.load("icons_category")||[{category_id:"101",category_name:"\u8db3\u7403"},{category_id:"102",category_name:"\u661f\u5ea7"},{category_id:"104",category_name:"\u5176\u4ed6"}];a.bindIconBookHookEvents(c)},bindIconBookHookEvents:function(b){var a=this;a._wrap.delegate(".j_icon_slot_buy","mouseenter",function(){a.__timeoutId&&clearTimeout(a.__timeoutId);a.closeAllCard();a._icon_user_action="buy_slot";a._target_ele=$(this);a._selected_icon_name="";var c=$(".j_icon_slot").length;a._slot_no=1;var d={add_slot_no:c+1,category_info:b,price:a._slot_buy_price[c+1],action:"buy_slot"};a.buySlot(d,$(this));return false});a._wrap.delegate(".j_icon_slot_buy","mouseleave",function(){a.__timeoutId&&clearTimeout(a.__timeoutId);a.__timeoutId=setTimeout(function(){if(a._messagebox){a._messagebox.hideBox()}},1000);return false});a._wrap.delegate(".j_icon_slot","click",function(j){a.closeAllCard();a._setIconRefresh($(this));a._icon_user_action="replace_icon";a._target_ele=$(this);var d=$(this).tbattr("data-slot");var f=$(this).tbattr("data-name");a._selected_icon_name=f;a._slot_no=d;var h="";var c=PageData.new_iconInfo||{};for(var g in c){if(c[g].name==f){h=c[g].category_id}}var i={slot_no:d,category_info:b,icon_id:f,action:"replace_icon",category_id:h};a.initIconBook(i,$(this));j.preventDefault()});a._wrap.delegate(".j_slot_null_icon","click",function(){a.closeAllCard();a._selected_icon_name="";a._setIconRefresh($(this));a._icon_user_action="buy_icon";a._target_ele=$(this);var c=$(this).tbattr("data-slot");a._slot_no=c;var d={slot_no:c,category_info:b,icon_id:"",action:"buy_icon"};a.initIconBook(d,$(this))});a._wrap.delegate(".j_icon_slot","hover",function(j){var o=$(this);var h=$(this).tbattr("data-name");var f=$(this).tbattr("data-slot");var k=PageData.new_iconInfo;if(!k){return}var n="http://tb1.bdstatic.com/tb/cms/com/icon/icon_sprite.png";var m=null;for(var p in k){if(k[p].name==h){m=k[p];break}}if(!m){return}var d=m["level_"+m.value];var c="url("+d.icon_1+") no-repeat";var l=j||event;if(l.type=="mouseenter"){var i={background:c};var g=o.css("background");if(!g){g=o[0].style.background}o.data({bg:g});o.css(i);o.addClass("icon_slot_hover");o.children(".j_icon_slot_refresh").addClass("icon_slot_refresh_hover")}else{var g=o.data("bg");var i={background:g};o.css(i);o.removeClass("icon_slot_hover");o.children(".j_icon_slot_refresh").removeClass("icon_slot_refresh_hover")}})},buySlot:function(c,b){var a=this;if(!a._messagebox){a._messagebox=a.use("common/widget/Icons/IconsBookMessagebox")}a._messagebox.is_leave_close=true;a._messagebox.showBox(c,b)},initIconBook:function(g,f){var a=this;var d=g.category_info;a.closeIconBook();var e=a._view.getTabItem(d);var c={content:e,card_css:{width:a._option.width,zIndex:$.getcurzIndex()},auto_positon:true,event_target:f,attr:"id='icon_book_tab'",wrap:$("body")};a._icon_book=a.use("common/widget/Icons/IconCard",c);a._icon_book.showCard({type:"delayShow",time:200});a.initTab();if(g.icon_id){var b=a._getTabIdByCategory(g.category_id);a._selected_icon_name=g.icon_id;a._showTab(b,g.icon_id)}else{a.setDefaultTab(1)}},closeIconBook:function(){var a=this;if(a._tip){a._tip.closeTip()}if(a._icon_book){a._icon_book.closeCard();a._icon_book=null}},initTab:function(){var a=this;a.tabLen=$(".icon_book_tab_head li").length;a._bindHeadEvents()},setDefaultTab:function(b){var a=this;a._showTab(b)},_bindHeadEvents:function(){var a=this;$(".icon_book_tab_head").delegate("li","click",function(){var b=$(this).index();a._showTab(b);if(a._tip){a._tip.hideTip()}});$(".icon_book_close").click(function(){$("#icon_book_tab").remove();if(a._tip){a._tip.hideTip();a._tip=null}$(".icon_wrap .j_icon_slot_refresh").removeClass("icon_slot_refresh");return false});$(".icon_book_close").hover(function(){$(this).addClass("icon_book_close_hover")},function(){$(this).removeClass("icon_book_close_hover")})},_showTab:function(b,c){var a=this;$(".icon_book_tab_head .head_inner").each(function(){if(!$(this).hasClass("space")&&$(this).parent().index()<a.tabLen-1){$(this).addClass("space")}});b<0?"0":$("#tab_head_"+(b-1)+" div.space").removeClass("space");$(".icon_book_tab_head li.tab_active").removeClass("tab_active").addClass("tab_deactive");$("#tab_head_"+b).removeClass("tab_deactive").addClass("tab_active");$(".icon_book_tab_body div.tab_body_item_active").removeClass("tab_body_item_active");$("#tab_content_"+b).addClass("tab_body_item_active");c=c||a._selected_icon_name;a._loadTabContent(b,c);a._current_tab_index=c},_loadTabContent:function(c,f){var a=this;var b='<div class="icon_book_error">\u6b63\u5728\u52aa\u529b\u52a0\u8f7d\uff0c\u8bf7\u7a0d\u540e...</div>';$("#tab_content_"+c).html(b);var e={ie:"utf-8"};var d=$("#tab_head_"+c).tbattr("data-categoryId");e.tbs=PageData.tbs;e.category_id=d;a._icon_book_ajax&&a._icon_book_ajax.abort();a._icon_book_ajax=$.ajax({type:"post",url:"/icon/get/icon",data:e,dataType:"json"}).success(function(i){if(i&&i.no===0){var j=i.data;var h=j.icon_info;var g=a._view.getTabContent(h,f,d);$("#tab_content_"+c).html(g);a._bindTabContenEvent(c);a.initScroll(c);a._icon_tab_loaded[c]=true;a._icon_info["category_"+c]=j.icon_info}else{var g='<div class="icon_book_error">\u672a\u77e5\u9519\u8bef<a href="javascript:void(0)" id="icon_book_reload" class="icon_book_reload">\u5237\u65b0</a></div>';$("#tab_content_"+c).html(g);$("#icon_book_reload").on("click",function(){a._loadTabContent(c);return false})}})},_bindTabContenEvent:function(b){var a=this;if(!a._tip){a._tip=a.use("common/widget/Icons/IconsBookTip",[a])}var c=$("#icon_book_wrap");c.on("mouseenter",".tab_body_item_active .icon_box_place",function(){$(this).children(".icon_border").addClass("icon_border_hover")}).on("mouseleave",".tab_body_item_active .icon_box_place",function(){$(this).children(".icon_border").removeClass("icon_border_hover")});c.delegate(".icon_wrap .icon_box_place","mouseenter",function(){$(this).parent().parent().find(".icon_subscript").removeClass("icon_selected");$(this).children(".icon_subscript").addClass("icon_selected");var e=a._target_ele.tbattr("data-name");var j=$(this).tbattr("data-id");var d=$(this).tbattr("data-level");var m=$(this).hasClass("icon_not_use");var k=$(".icon_book .tab_body_item_active")[0].id.replace("tab_content_","");var n=a._icon_info["category_"+k];var l=null;var f=null;if(n){n=n.normal||[];for(var h=0;h<n.length;h++){if(n[h].name==j){l=n[h]}if(e&&n[h].name==e){f=n[h]}}}var g={icon_id:j,in_use:!m,slot_no:a._slot_no,value:d,icon_info:l,old_icon_id:e,old_icon_info:f};a._tip.showTip(g,$(this))});c.delegate(".icon_view","mouseleave",function(){setTimeout(function(){a._tip.hideTip()},1500)});c.delegate(".collect_icon_wrap .icon_box_place","mouseenter",function(){if($(this).children(".icon_locked").length>0){return}$(this).parent().parent().find(".icon_subscript").removeClass("icon_selected");$(this).children(".icon_subscript").addClass("icon_selected");var e=a._target_ele.tbattr("data-name");var j=$(this).tbattr("data-id");var d=$(this).tbattr("data-level");var m=$(this).hasClass("icon_not_use");var k=$(".icon_book .tab_body_item_active")[0].id.replace("tab_content_","");var n=a._icon_info["category_"+k];var l=null;var f=null;if(n){n=n.advanced||[];for(var h=0;h<n.length;h++){if(n[h].name==j){l=n[h]}if(e&&n[h].name==e){f=n[h]}}}var g={icon_id:j,in_use:!m,slot_no:a._slot_no,value:d,icon_info:l,old_icon_id:e,old_icon_info:f};a._tip.showTip(g,$(this))});c.delegate(".collect_icon_wrap .icon_box_place","mouseleave",function(){setTimeout(function(){a._tip.hideTip()},6000)})},_getTabIdByCategory:function(c){var b=$(".icon_book_tab_head li");for(var a=0;a<b.length;a++){if($(b[a]).tbattr("data-categoryId")==c){return a}}return 0},initScroll:function(c){var b=this;var a=$("#tab_content_"+c+" .icon_wrap");if(a&&a.length>0){b.bindArrowScrollEvent("icon_wrap")}var d=$("#tab_content_"+c+" .collect_icon_wrap");if(d&&d.length>0){b.bindArrowScrollEvent("collect_icon_wrap")}},bindArrowScrollEvent:function(b){var a=this;$("."+b).delegate(".icon_wrap_scroll_arrow","hover",function(){if(!$(this).hasClass("arrow_disable")){$(this).toggleClass("arrow_hover")}});$("."+b).delegate(".right_arrow","click",function(){a._move("left",b);if(a._tip){a._tip.hideTip()}});$("."+b).delegate(".left_arrow","click",function(){a._move("right",b);if(a._tip){a._tip.hideTip()}})},_move:function(d,c){var b=this;var f=0;var e=$($(".tab_body_item_active ."+c+" .icon_view")[0]).tbattr("total-col");e=parseInt(e);switch(d){case"left":f=b._moveLeft(e,c);break;case"right":f=b._moveRight(e,c);break}if(f){$(".tab_body_item_active .icon_wrap .icon_list").animate({left:f},300)}var a=e*55;if(f){f=Math.abs(parseInt(f));if(f+550>=a){$(".tab_body_item_active ."+c+" .icon_wrap_right_arrow").addClass("arrow_disable");$(".tab_body_item_active ."+c+" .icon_wrap_left_arrow").removeClass("arrow_disable")}else{$(".tab_body_item_active ."+c+" .icon_wrap_right_arrow").removeClass("arrow_disable");$(".tab_body_item_active ."+c+" .icon_wrap_left_arrow").removeClass("arrow_disable")}if(f==0){$(".tab_body_item_active ."+c+" .icon_wrap_right_arrow").removeClass("arrow_disable");$(".tab_body_item_active ."+c+" .icon_wrap_left_arrow").addClass("arrow_disable")}}},_moveLeft:function(f,c){var a=0;var d=f;if(d<=10){return}var g=d*55;var e=$(".tab_body_item_active ."+c+" .icon_list").css("left");var h=Math.abs(parseInt(e));if(h%55!=0){h=(h%55)*55}var b=g-h;if(b>550){a=h+3*55}else{return}return"-"+a+"px"},_moveRight:function(e,b){var a=0;var c=e;if(c<=10){return}var f=c*55;var d=$(".tab_body_item_active ."+b+" .icon_list").css("left");var g=parseInt(d);if(g>=0){return}a=Math.abs(g)-3*55;if(a<0){a=0}return"-"+a+"px"},closeAllCard:function(){var a=this;if(a._tip){a._tip.closeTip()}if(a._messagebox){a._messagebox.hideBox()}a.closeIconBook();a._removeIconRefresh()},_setIconRefresh:function(a){$(".icon_wrap .j_icon_slot_refresh").removeClass("icon_slot_refresh");a.children(".j_icon_slot_refresh").addClass("icon_slot_refresh")},_removeIconRefresh:function(){$(".icon_wrap .j_icon_slot_refresh").removeClass("icon_slot_refresh")}}});