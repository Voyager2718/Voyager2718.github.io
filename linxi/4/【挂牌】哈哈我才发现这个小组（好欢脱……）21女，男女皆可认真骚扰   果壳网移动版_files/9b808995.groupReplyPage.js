!function(a){function b(b,h,n){k=b+h[0].name,e=h,j=b,i=a.extend({timeout:0,data:{}},n),i.timeout&&i.timeoutCallback&&(f=setTimeout(function(){m||(l=!0,i.timeoutCallback.call(null))},1e3*i.timeout),b+h[0].name in g&&clearTimeout(g[k]),g[k]=f),i.asyncPrepare?i.asyncPrepare.call(null,d):c()}function c(){var b=Math.random().toString(36).substring(2),c="hidden_iframe_"+b,d="hidden_form_"+b,f=e,g=f.parent(),n=f.next(),o=a('<iframe id="'+c+'" name="'+c+'" />').css("display","none").appendTo("body"),p=f.wrap("<form/>").parent().css({position:"absolute",top:"-1200px",left:"-1200px"}).attr({id:d,name:d,target:c,enctype:"multipart/form-data",encoding:"multipart/form-data",action:j,method:"POST"}).appendTo("body");h[k]=b,a.each(i.data,function(b,c){a('<input type="hidden"/>').attr("name",b).val(c).appendTo(p)}),o.bind("load",function(){var a;try{a=o.contents().find("body").text()}catch(c){}h[k]==b&&!l&&i.success&&a&&(m=!0,i.success.call(null,a))}),p.submit(),f.unwrap(),n.length?n.before(f):f.appendTo(g)}function d(b){i.data=a.extend(i.data,b),c()}a.fn.contents=function(){return this.map(function(){return this.contentDocument||slice.call(this.childNodes)})};var e,f,g={},h={},i={data:{access_token:""}},j="",k="",l=!1,m=!1,n=[];Editor=function(){this.init.apply(this,arguments)},Editor.prototype={_container:a(".cmt-form"),_submitForm:a(".cmt-form input[name=content]"),defaultOption:{quote:!0,uploadImg:!0,msite:!0},_option:{},imgId:0,formClicked:0,init:function(b,c,d){var e=this;e._container=b||e._container,e._submitForm=c||e._submitForm,e._option=a.extend({},e.defaultOption,d),e._option.quote&&e.quote(),e._option.uploadImg&&e.uploadImg(),!(e._option.quote||e._option.uploadImg||e._option.msite)},quote:function(){var b=this,c=b._container.find("textarea");a(".comments").delegate(".cmt-btn","click",function(){var b=a(this),d=b.parents(".comment").find(".cmt-main"),e=c.offset().top,f=d.clone(),g=b.parents(".comment").find(".cmt-author span").text();f.find("blockquote").remove();var h=f.text(),i=h.length>100?h.slice(1,100).replace(/</g,"&lt;").replace(/>/g,"&gt;")+"...":h.replace(/</g,"&lt;").replace(/>/g,"&gt;"),j="<blockquote>引用@"+g+" 的话："+i+"</blockquote>";a.scrollTo({endY:e,duration:500,callback:function(){a(j).insertBefore(c)}})})},uploadImg:function(){var b=this,c=(b._container,b._container.find(".form-foot"));c.append('<a class="icon-upload-img" id="uploadBtn" href="javascript:void 0;">插入图片</a><span class="upload-state" id="uploadState"></span>'),b._container.append('<div class="uploader" id="uploader"></div>');var d=a("#uploader");d.append('<form action="/apis/image.json?enable_watermark=true" id="upload" method="POST" enctype="multipart/form-data" class="uploader"><input type="file" name="upload_file" id="trueFile" class="upload-input" accept="image/*"/></form>'),d.append('<ul class="upload-list" id="uploadScale"></ul>'),b.uploadSetup(),c.delegate("#uploadBtn","click",function(){return a("#trueFile").trigger("click"),!1})},uploadSetup:function(){var c,d=this,e=a("#trueFile"),f=["jpeg","jpg","png","gif"];e.bind("change",function(g){if(g.preventDefault(),""===e.val())return!1;var h=e.val(),i=(h.length,h.split("."));if(i=i.length>1?i[i.length-1].toLowerCase():"",-1===a.inArray(i,f))return alert("图片格式不支持"),!1;var j=a("#uploadState");j.html("正在上传...").show(),b("/apis/image.json?enable_watermark=true",e,{asyncPrepare:function(a){c=GM.utils.cookie("_32353_access_token"),a({access_token:c})},success:function(b){try{b=a.parseJSON(b)}catch(c){b=/too large/i.test(b)?{errmsg:"文件太大了"}:{errmsg:"未知错误"}}if(b)if(b.ok){var e=a("#uploadScale"),f=a("#uploadState");e.find("li").length||e.show();var g=b.result,h="__UPLOADERS-"+d.imgId++,i={id:h,src:b.result.url};if(n.push(i),g.width<63||g.height<63)e.append('<li class="upload-list-item" data-id="'+i.id+'"><img src="'+g.url+'"/><a href="javascript:void 0;" class="icon-close-small">x</a></li>');else{var j=g.url.replace(/\/image\//,"/thumbnail/").replace(/(\.[a-z]+$)/,"_63x63$1");e.append('<li class="upload-list-item" data-id="'+i.id+'"><img src="'+j+'"/><a href="javascript:void 0;" class="icon-close-small">x</a></li>')}e.delegate("a.icon-close-small","click",function(){for(var b=a(this).parents("li.upload-list-item"),c=b.data("id"),d=0;d<n.length;d++)n[d].id==c&&n.splice(d,1);return b.remove(),a("#uploadScale li").length||e.hide(),!1}),f.hide()}else{var f=a("#uploadState");f.html(b.error)}},timeout:30})})},formSubmit:function(b){var c=this,d=c._container;d.delegate("button[type=submit]","click",function(e){e.stopPropagation();var f="",g=a(this);if(c.formClicked>1&&(e.preventDefault(),c.formClicked++),!c.formClicked){if(e.preventDefault(),c.formClicked++,b&&!b())return void(c.formClicked=0);c._option.quote&&(f+=c.addQuote()),f+=d.find("textarea").val(),c._option.uploadImg&&(f+=c.addImg());var h=a("#verifyTip"),i=a('<p class="form-tip" id="verifyTip"></p>');if(""===f)return h.length||d.append(i),a("#verifyTip").html("请填写内容"),void(c.formClicked=0);h.length&&h.html(""),c._option.msite&&(f+=c.addMsite()),c._submitForm.val(f),g.html("提交中"),d.find("form").submit()}})},addQuote:function(){var a=this,b="",c=a._container.find("blockquote");if(c.length)for(var d=0;d<c.length;d++)b+="[blockquote][color=#999]"+c.eq(d).html()+"[/color][/blockquote]";return b},addImg:function(){var a=n,b="";if(a.length)for(var c=0;c<a.length;c++)a[c]&&(b+="[img]"+a[c].src+"[/img]");return b},addMsite:function(){return'[blockquote]来自[url="http://m.guokr.com"]果壳网移动版[/url][/blockquote]'}}}(Zepto),$(function(){function changePic(a){a.preventDefault(),$captchaPic.attr("src",pic+"?v="+v++)}function joinGroup(id,type,cb){var token=GM.utils.cookie("_32353_access_token");$.ajax({url:"/apis/group/member.json",data:{group_id:id,access_token:token},type:type,success:function(a){a.ok&&cb&&cb()},error:function(data){var json=eval("("+data.responseText+")");241001==json.error_code?alert("该小组不存在"):241016==json.error_code?alert("你不是这个小组的成员"):241017==json.error_code?alert("你是这个小组的管理员，不能退出"):241014==json.error_code&&alert("你在这个小组的黑名单里，不能加入")},dataType:"json"})}GM.vars.GA_TYPE="groupReplyPage",$(".cmt-main img").css({"max-width":"200px",width:"auto",height:"auto"});var editor=new Editor($(".cmt-form"),$(".cmt-form input[name=content]"),{quote:!0,uploadImg:!0,msite:!0});if(editor.formSubmit(),$("#captchaImage").length){var $captchaPic=$("#captchaImage"),$captchaChange=$("#changeCaptchaImage"),pic=$captchaPic.attr("src"),v=1;$captchaChange.click(changePic),$captchaPic.click(changePic)}$(".main").delegate("a[data-operation]","click",function(a){a.preventDefault();var b=$(this),c=b.attr("data-operation"),d=b.attr("data-group_id");"yes"!==b.attr("data-login")||ukey||(window.location.href=url_signin),ukey&&"join"===c&&joinGroup(d,"POST",function(){window.location.reload()})})});